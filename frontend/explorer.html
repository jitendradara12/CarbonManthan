<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Public Explorer – Blue Carbon Registry</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root { --green:#1B9E77; --amber:#E6AB02; --orange:#D95F02; }
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; }
    header { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid #e5e7eb; }
    header h1 { font-size:16px; margin:0; }
    #map { height: calc(100% - 50px); }
  .legend { position:absolute; bottom:16px; left:16px; z-index:998; background:#fff; padding:8px 10px; border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,.08); font-size:12px; color:#374151; }
  .legend h4 { margin:0 0 6px 0; font-size:12px; color:#111827; }
  .legend .item { display:flex; align-items:center; gap:8px; margin:4px 0; }
  .dot { width:10px; height:10px; border-radius:50%; display:inline-block; box-shadow:0 0 0 1px rgba(0,0,0,.15) inset; }
  .dot.green { background: var(--green); }
  .dot.amber { background: var(--amber); }
  .dot.orange { background: var(--orange); }
  #loading { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.6); z-index:1000; font-weight:600; color:#111827; }
    .status-pill { display:inline-block; padding:8px 14px; border-radius:28px; color:#fff; font-size:12px; }
    .pill-Approved { background: var(--green); }
    .pill-Pending { background: var(--amber); }
    .pill-Rejected { background: var(--orange); }
    .popup { max-width: 280px; }
    .popup img { width:100%; height:auto; border-radius:16px; margin:8px 0; }
    .controls { position:absolute; top:64px; right:16px; z-index:999; background:#fff; padding:14px; border-radius:22px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .controls input, .controls select { font:inherit; padding:6px 8px; border-radius: 24px; }
    .controls input, .controls select, .controls button { font:inherit; padding:6px 8px; }
    .chipbar { display:flex; gap:6px; margin-top:6px; flex-wrap:wrap; }
    .chip { border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer; }
    .chip.approved { border-color:#1B9E77; color:#1B9E77; }
    .chip.pending { border-color:#E6AB02; color:#B45309; }
    .chip.rejected { border-color:#D95F02; color:#B91C1C; }
  .chip.active { background:#111827; color:#fff; border-color:#111827; }
  /* Side panel */
  .sidepanel { position:absolute; top:50px; right:0; width:360px; max-width:90vw; height:calc(100% - 50px); background:#fff; box-shadow:-2px 0 12px rgba(0,0,0,.08); transform: translateX(100%); transition: transform .25s ease; z-index:1000; display:flex; flex-direction:column; }
  .sidepanel.open { transform: translateX(0); }
  .sidepanel header { padding:12px 14px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
  .sidepanel .content { padding:12px 14px; overflow:auto; }
  .sidepanel .thumbs { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
  .btn-close { background:#111827; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; }
  .btn-link { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:6px 10px; cursor:pointer; font:inherit; }
  </style>
  <script>
    window.API_BASE = '/api';
  </script>
</head>
<body>
  <header>
    <h1>India Blue Carbon – Public Explorer</h1>
    <nav>
      <a href="/frontend/index.html">Dashboard</a>
    </nav>
  </header>
  <div id="map"></div>
  <aside id="panel" class="sidepanel" aria-hidden="true">
    <header>
      <strong id="p-title">Details</strong>
      <button id="p-close" class="btn-close">Close</button>
    </header>
    <div class="content" id="p-body"></div>
  </aside>
  <div class="controls">
    <select id="status">
      <option value="">All statuses</option>
      <option>Approved</option>
      <option>Pending</option>
      <option>Rejected</option>
    </select>
    <input id="search" placeholder="Search name or location" />
    <label style="font-size:12px;display:inline-flex;gap:6px;align-items:center;margin:0 8px;">
      <input id="inView" type="checkbox" /> Only within map
    </label>
    <button id="apply">Apply</button>
    <button id="reset">Reset view</button>
    <div class="chipbar">
      <button class="chip" data-chip-status="">All</button>
      <button class="chip approved" data-chip-status="Approved">Approved</button>
      <button class="chip pending" data-chip-status="Pending">Pending</button>
      <button class="chip rejected" data-chip-status="Rejected">Rejected</button>
    </div>
  </div>
  <div class="legend" id="legend">
    <h4>Projects</h4>
    <div class="item"><span class="dot green"></span> Approved: <strong id="cnt-approved">0</strong></div>
    <div class="item"><span class="dot amber"></span> Pending: <strong id="cnt-pending">0</strong></div>
    <div class="item"><span class="dot orange"></span> Rejected: <strong id="cnt-rejected">0</strong></div>
    <div class="item" style="margin-top:6px; border-top:1px solid #e5e7eb; padding-top:6px;">Total: <strong id="cnt-total">0</strong></div>
  </div>
  <div id="loading">Loading…</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    (function(){
      const API = () => (window.API_BASE || '/api');
      const indiaBounds = [[6.0, 68.0], [37.5, 97.5]]; // [S,W], [N,E]
      const statusColors = { Approved:'#1B9E77', Pending:'#E6AB02', Rejected:'#D95F02' };

      const map = L.map('map');
      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      map.fitBounds(indiaBounds);

      const clusters = L.markerClusterGroup();
      map.addLayer(clusters);

      // Keep some UI state
      let lastETag = null;
      let isInitialLoad = true;
      let openFeatureId = null;
      let markersById = new Map();
      map.on('popupopen', (e) => {
        const layer = e.layer;
        if (layer && layer._featureId != null) {
          openFeatureId = layer._featureId;
        }
        const pid = layer && layer._featureId;
        if (pid) {
          const el = document.getElementById(`supply-${pid}`);
          if (el) {
            fetch(`${API()}/public/projects/${pid}`)
              .then(r => r.ok ? r.json() : null)
              .then(d => {
                if (!d || !d.supply) { el.textContent = ''; return; }
                const rem = d.supply.remaining;
                if (typeof rem === 'number') el.textContent = `Remaining: ${rem} credits`;
              })
              .catch(()=>{ if (el) el.textContent=''; });
          }
          // Wire details button
          setTimeout(() => {
            const btn = document.querySelector(`.leaflet-popup [data-detail-id="${pid}"]`);
            if (btn) {
              btn.onclick = (ev) => { ev.preventDefault(); openPanel(pid); };
            }
          }, 0);
        }
      });

      function markerFor(feature){
        const st = feature.properties.status;
        const color = statusColors[st] || '#3388ff';
  const icon = L.divIcon({ className:'', html:`<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.2)"></div>`, iconSize:[20,20] });
        const [lon, lat] = feature.geometry.coordinates;
        const m = L.marker([lat, lon], { icon });
        const p = feature.properties;
        m._featureId = p.id;
        const chain = p.onchain_project_id ? `On-chain: #${p.onchain_project_id} · ${p.total_credits_minted || 0} credits` : 'On-chain: Not yet';
        const img = p.cover_image_url ? `<img src="${p.cover_image_url}" alt="cover"/>` : '';
        const html = `<div class="popup">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <strong>${p.name}</strong>
            <span class="status-pill pill-${p.status}">${p.status}</span>
          </div>
          <div style="color:#555">${p.location_text || ''}</div>
          ${img}
          <div>Area: ${p.area_hectares ?? '—'} ha</div>
          <div>${chain}</div>
          <div id="supply-${p.id}" style="font-size:12px;color:#4b5563;margin-top:4px;">Checking supply…</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
            <button class="btn-link" data-detail-id="${p.id}">Details</button>
            <a class="btn-link" href="${API()}/public/projects/${p.id}" target="_blank" rel="noopener">JSON</a>
          </div>
        </div>`;
        m.bindPopup(html);
        return m;
      }

      function currentBBox(){
        const b = map.getBounds();
        const sw = b.getSouthWest();
        const ne = b.getNorthEast();
        // bbox=minx,miny,maxx,maxy (lon/lat)
        return `${sw.lng},${sw.lat},${ne.lng},${ne.lat}`;
      }

      async function loadData(opts={fit:false, source:'manual'}){
        const s = document.getElementById('status').value;
        const q = document.getElementById('search').value.trim();
        const inView = document.getElementById('inView').checked;
        const params = new URLSearchParams();
        if (s) params.set('status', s);
        if (q) params.set('q', q);
        if (inView) params.set('bbox', currentBBox());
        const url = `${API()}/public/projects.geojson?${params.toString()}`;
        const headers = { 'Accept':'application/geo+json, application/json' };
        if (lastETag) headers['If-None-Match'] = lastETag;
        // show loading overlay
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'flex';
        const resp = await fetch(url, { headers }).catch(()=>null);
        if (loading) loading.style.display = 'none';
        if (!resp || !resp.ok) { console.error('Failed to load GeoJSON'); return; }
        const newETag = resp.headers.get('ETag');
        if (newETag && lastETag && newETag === lastETag) {
          // No change, keep current markers and popup
          return;
        }
        const data = await resp.json();
        lastETag = newETag || null;
        // Rebuild clusters
        const prevOpenId = openFeatureId;
        openFeatureId = null;
        markersById = new Map();
        clusters.clearLayers();
        const feats = (data.features || []);
        (feats).forEach(f => {
          const m = markerFor(f);
          markersById.set(m._featureId, m);
          clusters.addLayer(m);
        });
        // update legend counts
        const cnt = { Approved:0, Pending:0, Rejected:0 };
        feats.forEach(f=>{ const st=f.properties?.status; if (cnt[st] != null) cnt[st]++; });
        document.getElementById('cnt-approved').textContent = cnt.Approved;
        document.getElementById('cnt-pending').textContent = cnt.Pending;
        document.getElementById('cnt-rejected').textContent = cnt.Rejected;
        document.getElementById('cnt-total').textContent = feats.length;
        const shouldFit = opts.fit || (isInitialLoad && !inView);
        if (shouldFit) {
          if ((data.features || []).length) {
            const bb = L.geoJSON(data).getBounds();
            if (bb.isValid()) map.fitBounds(bb.pad(0.2));
          } else {
            map.fitBounds(indiaBounds);
          }
        }
        isInitialLoad = false;
        // Restore open popup if possible
        if (prevOpenId && markersById.has(prevOpenId)) {
          const layer = markersById.get(prevOpenId);
          clusters.zoomToShowLayer(layer, () => layer.openPopup());
        }
      }

      document.getElementById('apply').onclick = () => {
        const inView = document.getElementById('inView').checked;
        loadData({ fit: !inView, source: 'apply' });
      };
      document.getElementById('reset').onclick = () => {
        map.fitBounds(indiaBounds);
      };
      // Quick status chips
      document.querySelectorAll('.chip[data-chip-status]').forEach(btn => {
        btn.onclick = () => {
          const val = btn.getAttribute('data-chip-status') || '';
          const sel = document.getElementById('status');
          sel.value = val;
          document.querySelectorAll('.chip[data-chip-status]').forEach(b=>b.classList.toggle('active', b===btn));
          const inView = document.getElementById('inView').checked;
          loadData({ fit: !inView, source: 'chip' });
        };
      });
      // Debounce helper
      let timer = null;
      function debounce(fn, wait=250){
        clearTimeout(timer);
        timer = setTimeout(fn, wait);
      }
      map.on('moveend', () => {
        if (document.getElementById('inView').checked) debounce(() => loadData({ fit:false, source:'move' }), 350);
      });
      loadData({ fit:true, source:'init' });

      // Panel logic
      const panel = document.getElementById('panel');
      const pTitle = document.getElementById('p-title');
      const pBody = document.getElementById('p-body');
      const pClose = document.getElementById('p-close');
      if (pClose) pClose.onclick = () => { panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); };
      async function openPanel(id){
        try {
          const r = await fetch(`${API()}/public/projects/${id}`);
          if(!r.ok) return;
          const d = await r.json();
          pTitle.textContent = d.name || 'Details';
          const pill = `<span class="status-pill pill-${d.status}">${d.status}</span>`;
          const imgs = (d.images||[]).slice(0,4).map(u=>`<img src="${u}" style="width:100%;height:auto;border-radius:8px;"/>` ).join('');
          pBody.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <div>
                <div style="font-size:13px;color:#6b7280;">${d.location_text||''}</div>
                <div style="font-size:13px;color:#6b7280;">Area: ${d.area_hectares ?? '—'} ha</div>
              </div>
              ${pill}
            </div>
            <div style="margin-top:8px;font-size:13px;color:#374151;">Remaining: <strong>${d.supply?.remaining ?? '—'}</strong> · Minted: <strong>${d.supply?.minted ?? '—'}</strong></div>
            <div class="thumbs">${imgs || '<div style="grid-column:1/-1;color:#6b7280;">No images yet</div>'}</div>
          `;
          panel.classList.add('open');
          panel.setAttribute('aria-hidden','false');
        } catch(e) { /* ignore */ }
      }
    })();
  </script>
</body>
</html>
